from extensions import db
from datetime import datetime

# ==================== MANY-TO-MANY TABLES ======================

compulsarysubject_class = db.Table(
    "compulsarysubject_class",
    db.Column("classroom_id", db.Integer, db.ForeignKey("classroom.id"), primary_key=True),
    db.Column("subject_id", db.Integer, db.ForeignKey("compulsary_subject.id"), primary_key=True),
)

teacher_school_record_class = db.Table(
    "teacher_school_record_class",
    db.Column("teacher_school_record_id", db.Integer, db.ForeignKey("teacherschoolrecord.id"), primary_key=True),
    db.Column("classroom_id", db.Integer, db.ForeignKey("classroom.id"), primary_key=True),
)

# ==================== SUBJECT MODELS ========================

class CompulsarySubject(db.Model):
    __tablename__ = "compulsary_subject"

    id = db.Column(db.Integer, primary_key=True)
    subject_name = db.Column(db.String(50), nullable=False, unique=True)
    subject_code = db.Column(db.String(50), nullable=False, unique=True)


class OptionalSubject(db.Model):
    __tablename__ = "optional_subject"

    id = db.Column(db.Integer, primary_key=True)
    subject_name = db.Column(db.String(50), nullable=False, unique=True)
    subject_code = db.Column(db.String(50), nullable=False, unique=True)

    classroom_id = db.Column(db.Integer, db.ForeignKey("classroom.id"))

# ==================== CLASSROOM =============================

class Classroom(db.Model):
    __tablename__ = "classroom"

    id = db.Column(db.Integer, primary_key=True)
    classroom_name = db.Column(db.String(50), nullable=False, unique=True)

    # many-to-many
    compulsary_subjects = db.relationship(
        "CompulsarySubject",
        secondary=compulsarysubject_class,
        backref="classrooms",
        lazy="joined"
    )

    # one-to-many
    optional_subjects = db.relationship("OptionalSubject", backref="classroom", lazy="joined")

    # many-to-many with teacher school record
    teacher_school_record = db.relationship(
        "TeacherSchoolRecord",
        secondary=teacher_school_record_class,
        backref="classrooms",
        lazy="joined"
    )

    # one-to-many: StudentSchoolRecord.classroom_id must exist (added in auth.models)
    student_school_record = db.relationship("StudentSchoolRecord", backref="classroom", lazy="joined")

    class_assignments = db.relationship("ClassAssignment", backref="classroom", lazy="joined")


# ==================== ATTENDANCE ===========================

class StudentAttendance(db.Model):
    __tablename__ = "student_attendance"

    id = db.Column(db.Integer, primary_key=True)
    is_present = db.Column(db.Boolean, nullable=False, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)

    # FKs to auth models (string names)
    student_id = db.Column(db.Integer, db.ForeignKey("students.id"))
    teacher_id = db.Column(db.Integer, db.ForeignKey("teachers.id"))
    admin_id = db.Column(db.Integer, db.ForeignKey("admins.id"))


# ==================== GRADES ===============================

class StudentGrade(db.Model):
    __tablename__ = "student_grade"

    id = db.Column(db.Integer, primary_key=True)

    exam_name = db.Column(db.String(50), nullable=False)
    exam_code = db.Column(db.String(50), nullable=False)
    exam_subject_name = db.Column(db.String(50), nullable=False)

    student_score = db.Column(db.Integer, nullable=False)
    student_grade = db.Column(db.String(5), nullable=False)

    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)

    student_id = db.Column(db.Integer, db.ForeignKey("students.id"))
    teacher_id = db.Column(db.Integer, db.ForeignKey("teachers.id"))
    admin_id = db.Column(db.Integer, db.ForeignKey("admins.id"))

    student = db.relationship("Student", backref="student_grades", lazy="joined")


# ==================== ASSIGNMENTS ===============================

class ClassAssignment(db.Model):
    __tablename__ = "classassignment"

    id = db.Column(db.Integer, primary_key=True)
    assignment_name = db.Column(db.String(50), nullable=False)
    assignment_code = db.Column(db.String(50), nullable=False)
    assignment_subject_name = db.Column(db.String(50), nullable=False)

    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, onupdate=datetime.utcnow)

    classroom_id = db.Column(db.Integer, db.ForeignKey("classroom.id"))

    assignment_file_uploads = db.relationship(
        "AssignmentFileUpload",
        backref="class_assignment",
        lazy="joined"
    )


class AssignmentFileUpload(db.Model):
    __tablename__ = "assignment_file_upload"

    id = db.Column(db.Integer, primary_key=True)
    filename = db.Column(db.String(500), nullable=False)
    filepath = db.Column(db.String(500), nullable=False)

    class_assignment_id = db.Column(db.Integer, db.ForeignKey("classassignment.id"))
