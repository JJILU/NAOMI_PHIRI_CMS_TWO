{% extends 'base.html' %}
{% block content %}

<div class="page-breadcrumb">
  <div class="row align-items-center">
    <div class="col-6">
      <h3 class="page-title mb-0">Study Materials</h3>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('dash.index') }}">Home</a></li>
          <li class="breadcrumb-item active">Study Materials</li>
        </ol>
      </nav>
    </div>
    <div class="col-6 text-end">
      {% if current_user.is_authenticated and current_user.role == 'teacher' %}
      <a href="{{ url_for('dash.create_study_material') }}" class="btn btn-primary">Create Study Material</a>
      {% endif %}
    </div>
  </div>
</div>

<div class="container-fluid">

  {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
  {% if success %}<div class="alert alert-success">{{ success }}</div>{% endif %}

  <!-- Per-page selector -->
  <div class="row mb-3">
    <div class="col-md-6">
      <form method="get" id="perPageForm">
        <label for="per_page">Items per page</label>
        <select name="per_page" id="per_page" class="form-select d-inline-block" style="width:auto" onchange="document.getElementById('perPageForm').submit()">
          {% for n in [3,6,9,12,18] %}
            <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
  </div>

  <div class="row justify-content-center">
    {% for mat in materials.items %}
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card">
        {% if mat.files and mat.files|length > 0 %}
        <img class="card-img-top img-responsive" src="{{ url_for('dash.studymaterial_uploaded_file', filename=mat.files[0].filename) }}" alt="Card">
        {% else %}
        <img class="card-img-top img-responsive" src="{{ url_for('static', filename='images/default-material.jpg') }}" alt="Card">
        {% endif %}
        <div class="card-body">
          <ul class="list-inline d-flex align-items-center">
            <li class="ps-0">{{ mat.created_at.strftime('%d %b %Y') }}</li>
            <li class="ms-auto"><a href="{{ url_for('dash.view_study_material', id=mat.id) }}" class="link">View</a></li>
          </ul>
          <h3 class="font-normal">{{ mat.title }}</h3>
          <p class="text-muted mb-1">{{ mat.description[:100] }}{% if mat.description|length > 100 %}...{% endif %}</p>
          <p class="mb-0"><small class="text-muted">Class: {% if mat.classroom %}{{ mat.classroom.classroom_name }}{% else %}All Classes{% endif %}</small></p>

          {% if current_user.is_authenticated and current_user.role == 'teacher' and current_user.id == mat.teacher_id %}
          <div class="mt-2">
            <a href="{{ url_for('dash.edit_study_material', id=mat.id) }}" class="btn btn-sm btn-outline-primary">Edit</a>
            <a href="{{ url_for('dash.delete_study_material_confirm', id=mat.id) }}" class="btn btn-sm btn-danger">Delete</a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-12">
      <div class="alert alert-info">No study materials found.</div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="row">
    <div class="col-12">
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
          {% if materials.has_prev %}
          <li class="page-item"><a class="page-link" href="{{ url_for('dash.list_study_material', page=1, per_page=per_page) }}">« First</a></li>
          <li class="page-item"><a class="page-link" href="{{ url_for('dash.list_study_material', page=materials.prev_num, per_page=per_page) }}">‹ Prev</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">« First</span></li>
          <li class="page-item disabled"><span class="page-link">‹ Prev</span></li>
          {% endif %}

          {% for p in materials.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
            <li class="page-item {% if p == materials.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('dash.list_study_material', page=p, per_page=per_page) }}">{{ p }}</a>
            </li>
            {% else %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
            {% endif %}
          {% endfor %}

          {% if materials.has_next %}
          <li class="page-item"><a class="page-link" href="{{ url_for('dash.list_study_material', page=materials.next_num, per_page=per_page) }}">Next ›</a></li>
          <li class="page-item"><a class="page-link" href="{{ url_for('dash.list_study_material', page=materials.pages, per_page=per_page) }}">Last »</a></li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">Next ›</span></li>
          <li class="page-item disabled"><span class="page-link">Last »</span></li>
          {% endif %}
        </ul>
      </nav>
    </div>
  </div>

</div>
{% endblock %}
